KEYCODES = {
    "BTN_PROG": "00d0",
    "BTN_OUTPUTS": "00d1",
    "BTN_SETUP": "00c7",
    "BTN_PATCH": "00d3",
    "BTN_MEDIA": "00e4",
    "BTN_EXEC": "00e5",
    "BTN_PAGE": "00cb",
    "BTN_CUE_STACK": "00d5",
    "BTN_CUE": "00c5",
    "BTN_PLAYBACK": "00d4",
    "BTN_STACK_STORE": "00cc",
    "BTN_CUE_STORE": "00cd",
    "BTN_TRK_MODE_1": "00dd",
    "BTN_TRK_MODE_2": "00de",
    "BTN_F1": "00a3",
    "BTN_TIMELINE": "00e3",
    "BTN_MACRO": "00c8",
    "BTN_HELP": "00c9",
    "BTN_NEXT_HEAD": "00b5",
    "BTN_PREV_HEAD": "00b6",
    "BTN_LOCATE": "00b0",
    "BTN_ODD_EVEN": "00b2",
    "BTN_HIGHLIGHT": "00d7",
    "BTN_SINGLE": "00b3",
    "BTN_FAN": "00b1",
    "BTN_ALL": "00b4",
    "BTN_RELEASE": "00d6",
    "BTN_SELECT": "00a4",
    "BTN_CLEAR": "00a7",
    "BTN_UNDO": "00a5",
    "BTN_REMOVE": "00ab",
    "BTN_MOVE": "00ad",
    "BTN_COPY": "00a9",
    "BTN_BLIND": "00c6",
    "BTN_BACKSPACE": "0008",
    "BTN_SET": "00ac",
    "BTN_INCLUDE": "00ae",
    "BTN_UPDATE": "00aa",
    "BTN_RECORD": "00af",
    "BTN_GROUP": "00c0",
    "BTN_INTENSITY": "00c1",
    "BTN_FX": "00d2",
    "BTN_POS": "00c2",
    "BTN_COLOUR": "00c3",
    "BTN_BEAM": "00c4",
    "BTN_LAYOUT_1": "00e0",
    "BTN_LAYOUT_2": "00e1",
    "BTN_LAYOUT_3": "00e2",
    "BTN_CLOSE": "00ba",
    "BTN_CURS_LEFT": "0012",
    "BTN_CURS_UP": "0010",
    "BTN_CURS_RIGHT": "0013",
    "BTN_CURS_DOWN": "0011",
    "BTN_THRU": "00a0",
    "BTN_NUM_DIVIDE": "002f",
    "BTN_NUM_MULTIPLY": "002a",
    "BTN_NUM_SUBTRACT": "002d",
    "BTN_NUM_ADD": "002b",
    "BTN_FULL": "00a1",
    "BTN_NUM_0": "0030",
    "BTN_NUM_1": "0031",
    "BTN_NUM_2": "0032",
    "BTN_NUM_3": "0033",
    "BTN_NUM_4": "0034",
    "BTN_NUM_5": "0035",
    "BTN_NUM_6": "0036",
    "BTN_NUM_7": "0037",
    "BTN_NUM_8": "0038",
    "BTN_NUM_9": "0039",
    "BTN_AT": "00a2",
    "BTN_NUM_DECIMAL": "002e",
    "BTN_RETURN": "000d",
    "BTN_S_1": "0127",
    "BTN_S_2": "0128",
    "BTN_S_3": "0129",
    "BTN_S_4": "012a",
    "BTN_S_5": "012b",
    "BTN_S_6": "012c",
    "BTN_S_7": "012d",
    "BTN_S_8": "012e",
    "BTN_S_9": "012f",
    "BTN_S_10": "0130",
    "BTN_GO_1": "0114",
    "BTN_GO_2": "0115",
    "BTN_GO_3": "0116",
    "BTN_GO_4": "0117",
    "BTN_GO_5": "0118",
    "BTN_GO_6": "0119",
    "BTN_GO_7": "011a",
    "BTN_GO_8": "011b",
    "BTN_GO_9": "011c",
    "BTN_GO_10": "011d",
    "BTN_PAUSE_1": "010a",
    "BTN_PAUSE_2": "010b",
    "BTN_PAUSE_3": "010c",
    "BTN_PAUSE_4": "010d",
    "BTN_PAUSE_5": "010e",
    "BTN_PAUSE_6": "010f",
    "BTN_PAUSE_7": "0110",
    "BTN_PAUSE_8": "0111",
    "BTN_PAUSE_9": "0112",
    "BTN_PAUSE_10": "0113",
    "BTN_FLASH_1": "0100",
    "BTN_FLASH_2": "0101",
    "BTN_FLASH_3": "0102",
    "BTN_FLASH_4": "0103",
    "BTN_FLASH_5": "0104",
    "BTN_FLASH_6": "0105",
    "BTN_FLASH_7": "0106",
    "BTN_FLASH_8": "0107",
    "BTN_FLASH_9": "0108",
    "BTN_FLASH_10": "0109",
    "BTN_DBO": "0126",
    "BTN_NEXT_PAGE": "0125",
    "BTN_ADD_SWAP": "00da",
    "BTN_PREV_PAGE": "0123",
    "BTN_GRAND_FLASH": "0120",
    "BTN_MASTER_FLASH": "0121",
    "BTN_MANUAL_GO": "011e",
    "BTN_MANUAL_FWD": "00db",
    "BTN_MANUAL_PAUSE": "011f",
    "BTN_MANUAL_BACK": "00dc",
    "BTN_122": "0122",
    "BTN_ENC_A": "013d",
    "BTN_ENC_B": "013e",
    "BTN_ENC_C": "013f",
    "BTN_ENC_D": "0140",
    "BTN_ENC_E": "0141",
    "BTN_ENC_F": "0142",
    "BTN_ENC_Y": "0143",
    "BTN_ENC_X": "0144",
    "KEY_BACKQUOTE": "0060",
    "KEY_1": "0031",
    "KEY_2": "0032",
    "KEY_3": "0033",
    "KEY_4": "0034",
    "KEY_5": "0035",
    "KEY_6": "0036",
    "KEY_7": "0037",
    "KEY_8": "0038",
    "KEY_9": "0039",
    "KEY_0": "0030",
    "KEY_MINUS": "002d",
    "KEY_EQUAL": "003d",
    "KEY_BACKSPACE": "0008",
    "KEY_SPACE": "0020",
    "KEY_a": "0061",
    "KEY_b": "0062",
    "KEY_c": "0063",
    "KEY_d": "0064",
    "KEY_e": "0065",
    "KEY_f": "0066",
    "KEY_g": "0067",
    "KEY_h": "0068",
    "KEY_i": "0069",
    "KEY_j": "006a",
    "KEY_k": "006b",
    "KEY_l": "006c",
    "KEY_m": "006d",
    "KEY_n": "006e",
    "KEY_o": "006f",
    "KEY_p": "0070",
    "KEY_q": "0071",
    "KEY_r": "0072",
    "KEY_s": "0073",
    "KEY_t": "0074",
    "KEY_u": "0075",
    "KEY_v": "0076",
    "KEY_w": "0077",
    "KEY_x": "0078",
    "KEY_y": "0079",
    "KEY_z": "007a",
    "KEY_A": "0041",
    "KEY_B": "0042",
    "KEY_C": "0043",
    "KEY_D": "0044",
    "KEY_E": "0045",
    "KEY_F": "0046",
    "KEY_G": "0047",
    "KEY_H": "0048",
    "KEY_I": "0049",
    "KEY_J": "004a",
    "KEY_K": "004b",
    "KEY_L": "004c",
    "KEY_M": "004d",
    "KEY_N": "004e",
    "KEY_O": "004f",
    "KEY_P": "0050",
    "KEY_Q": "0051",
    "KEY_R": "0052",
    "KEY_S": "0053",
    "KEY_T": "0054",
    "KEY_U": "0055",
    "KEY_V": "0056",
    "KEY_W": "0057",
    "KEY_X": "0058",
    "KEY_Y": "0059",
    "KEY_Z": "005a",
    "KEY_BRACKET_LEFT": "005b",
    "KEY_BRACKET_RIGHT": "005d",
    "KEY_BACKSLASH": "005c",
    "KEY_SEMICOLON": "003b",
    "KEY_QUOTE": "0027",
    "KEY_RETURN": "000d",
    "KEY_COMMA": "002c",
    "KEY_PERIOD": "002e",
    "KEY_SLASH": "002f",
    "KEY_PG_LEFT": "00d8",
    "KEY_PG_RIGHT": "00d9",
    "KEY_HOME": "0016",
    "KEY_END": "0017",
    "KEY_PG_UP": "0018",
    "KEY_PG_DOWN": "0019",
    "MOD_SHIFT": "0001",
    "MOD_CTRL": "0002",
    "MOD_ALT": "0003",
}


class Direction:
    PRESSED = 1
    RELEASED = 0


class Hex:
    @staticmethod
    def Format(n, fill=4):
        return "{:x}".format(n).zfill(fill)

    @staticmethod
    def Parse(s):
        return int(s, 16)


class String:
    @staticmethod
    def Format(s):
        return '"%s"' % s

    @staticmethod
    def Parse(s):
        return s.strip('"')


class Showfile:
    def __init__(self, header=[], data=[]):
        self.header = header
        self.data = data

    @staticmethod
    def Read(path):
        with open(path, "rb") as f:
            # Show files begin with a commented "header" that needs to be seperated
            header = []
            remaining_lines = []
            lines = f.read().decode().split("\r\n")
            for l in lines:
                if l.startswith("\\"):
                    header.append(l)
                else:
                    remaining_lines.append(l)

            remaining_lines = "".join(remaining_lines)

            # Extract each data block denoted by a semicolon followed by a newline
            data = [
                list(filter(lambda x: x, l.split(",")))
                for l in filter(
                    lambda x: x,
                    [
                        l.strip().replace("\r", "").replace("\n", "")
                        for l in remaining_lines.split(";")
                    ],
                )
            ]

            return Showfile(header=header, data=data)

    @staticmethod
    def Write(showfile, path):
        with open(path, "wb+") as f:
            f.write(
                (
                    "\r\n".join(showfile.header)
                    + "\r\n\r\n"
                    + ";\r\n".join([",".join(l) for l in showfile.data])
                ).encode()
            )


class Macro:
    def __init__(
        self,
        id=1,
        title="Macro",
        steps=[],
        var4="00000000",
        var5="0000",
        var6="0000",
        var7="0000",
        var8="0000",
        var9="00000000",
        var10="00000003",
        var11="0",
    ):
        self.id = id
        self.title = title
        self.steps = steps

        # Unknown vars (before steps)
        self.var4 = var4
        self.var5 = var5
        self.var6 = var6
        self.var7 = var7
        self.var8 = var8

        # Unknown vars (after steps)
        self.var9 = var9
        self.var10 = var10
        self.var11 = var11

    def __repr__(self):
        return 'Macro<M{}, "{}">({})'.format(self.id, self.title, len(self.steps))

    @staticmethod
    def Parse(data):
        id = Hex.Parse(data[1])
        title = String.Parse(data[2])
        n_steps = Hex.Parse(data[3])

        steps = []

        for i in range(n_steps):
            step = data[9 + i * 5 : 9 + ((i + 1) * 5)]
            steps.append(step)

        return Macro(
            id=id,
            title=title,
            steps=steps,
            var4=data[4],
            var5=data[5],
            var6=data[6],
            var7=data[7],
            var8=data[8],
            var9=data[-3],
            var10=data[-2],
            var11=data[-1],
        )

    @staticmethod
    def Format(macro):
        data = [
            "K",
            Hex.Format(macro.id),
            String.Format(macro.title),
            Hex.Format(len(macro.steps)),
            macro.var4,
            macro.var5,
            macro.var6,
            macro.var7,
            macro.var8,
        ]

        for step in macro.steps:
            data += step

        data += [macro.var9, macro.var10, macro.var11]

        return data


class MacroStep:
    @staticmethod
    def Mouse(time=0, var1="0000", x=0, y=0, direction=Direction.PRESSED):
        return [
            Hex.Format(time, fill=8),
            "0009",
            var1,
            Hex.Format(x) + Hex.Format(y),
            Hex.Format(direction, fill=8),
        ]

    @staticmethod
    def MouseDown(**kwargs):
        return MacroStep.Mouse(direction=Direction.PRESSED, **kwargs)

    @staticmethod
    def MouseUp(**kwargs):
        return MacroStep.Mouse(direction=Direction.RELEASED, **kwargs)

    @staticmethod
    def Key(
        time=0,
        var1="0000",
        key="KEY_SPACE",
        var3="00000000",
        direction=Direction.PRESSED,
    ):
        return [
            Hex.Format(time, fill=8),
            "0100",
            var1,
            {
                "BTN": ["0020", "00a0"],
                "KEY": ["0010", "0090"],
                "MOD": ["0000", "0080"],
            }[key.split("_")[0]][direction]
            + KEYCODES[key],
            var3,
        ]

    @staticmethod
    def KeyDown(**kwargs):
        return MacroStep.Key(direction=Direction.PRESSED, **kwargs)

    @staticmethod
    def KeyUp(**kwargs):
        return MacroStep.Key(direction=Direction.RELEASED, **kwargs)


# MACRO BUILDER API STUFF BELOW

MACRO = Macro()


class macro:
    @staticmethod
    def title(title):
        MACRO.title = title

    @staticmethod
    def id(id):
        MACRO.id = id

    @staticmethod
    def write(showfile):
        show = Showfile.Read(showfile)

        show.data = list(
            filter(
                lambda x: not (x[0] == "K" and Hex.Parse(x[1]) == MACRO.id), show.data
            )
        )

        for data in show.data:
            if data[0] == "K" and Hex.Parse(data[1]) == MACRO.id:
                raise Exception(
                    "Macro M{} already exists! ({})".format(
                        MACRO.id, String.Parse(data[2])
                    )
                )

        show.data.append(Macro.Format(MACRO))

        Showfile.Write(show, showfile)


class key:
    @staticmethod
    def down(k):
        MACRO.steps.append(MacroStep.KeyDown(key=k))

    @staticmethod
    def up(k):
        MACRO.steps.append(MacroStep.KeyUp(key=k))

    @staticmethod
    def press(k):
        key.down(k)
        key.up(k)


class mouse:
    @staticmethod
    def down(x, y):
        MACRO.steps.append(MacroStep.MouseDown(x=x, y=y))

    @staticmethod
    def up(x, y):
        MACRO.steps.append(MacroStep.MouseUp(x=x, y=y))

    @staticmethod
    def press(x, y):
        mouse.down(x, y)
        mouse.up(x, y)
